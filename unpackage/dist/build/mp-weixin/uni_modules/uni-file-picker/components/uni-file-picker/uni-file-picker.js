"use strict";var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,o=(e,t)=>{for(var i in t||(t={}))l.call(t,i)&&r(e,i,t[i]);if(s)for(var i of s(t))a.call(t,i)&&r(e,i,t[i]);return e},h=require("../../../../common/vendor.js"),n=require("./choose-and-upload-file.js"),u=require("./utils.js");const p={name:"uniFilePicker",components:{uploadImage:()=>"./upload-image.js",uploadFile:()=>"./upload-file.js"},emits:["select","success","fail","progress","delete","update:modelValue","input"],props:{modelValue:{type:[Array,Object],default:()=>[]},disabled:{type:Boolean,default:!1},disablePreview:{type:Boolean,default:!1},delIcon:{type:Boolean,default:!0},autoUpload:{type:Boolean,default:!0},limit:{type:[Number,String],default:9},mode:{type:String,default:"grid"},fileMediatype:{type:String,default:"image"},fileExtname:{type:[Array,String],default:()=>[]},title:{type:String,default:""},listStyles:{type:Object,default:()=>({border:!0,dividline:!0,borderStyle:{}})},imageStyles:{type:Object,default:()=>({width:"auto",height:"auto"})},readonly:{type:Boolean,default:!1},returnType:{type:String,default:"array"},sizeType:{type:Array,default:()=>["original","compressed"]}},data:()=>({files:[],localValue:[]}),watch:{modelValue:{handler(e,t){this.setValue(e,t)},immediate:!0}},computed:{filesList(){let e=[];return this.files.forEach((t=>{e.push(t)})),e},showType(){return"image"===this.fileMediatype?this.mode:"list"},limitLength(){return"object"===this.returnType?1:this.limit?this.limit>=9?9:this.limit:1}},created(){h.St.config&&h.St.config.provider||(this.noSpace=!0,h.St.chooseAndUploadFile=n.chooseAndUploadFile),this.form=this.getForm("uniForms"),this.formItem=this.getForm("uniFormsItem"),this.form&&this.formItem&&this.formItem.name&&(this.rename=this.formItem.name,this.form.inputChildrens.push(this))},methods:{clearFiles(e){0===e||e?this.files.splice(e,1):(this.files=[],this.$nextTick((()=>{this.setEmit()}))),this.$nextTick((()=>{this.setEmit()}))},upload(){let e=[];this.files.forEach(((t,i)=>{"ready"!==t.status&&"error"!==t.status||e.push(Object.assign({},t))})),this.uploadFiles(e)},async setValue(e,t){const i=async e=>{let t="";return t=e.fileID?e.fileID:e.url,/cloud:\/\/([\w.]+\/?)\S*/.test(t)&&(e.fileID=t,e.url=await this.getTempFileURL(t)),e.url&&(e.path=e.url),e};if("object"===this.returnType)e?await i(e):e={};else{e||(e=[]);for(let t=0;t<e.length;t++){let s=e[t];await i(s)}}this.localValue=e,this.form&&this.formItem&&!this.is_reset&&(this.is_reset=!1,this.formItem.setValue(this.localValue));let s=Object.keys(e).length>0?e:[];this.files=[].concat(s)},choose(){this.disabled||(this.files.length>=Number(this.limitLength)&&"grid"!==this.showType&&"array"===this.returnType?h.index.showToast({title:`您最多选择 ${this.limitLength} 个文件`,icon:"none"}):this.chooseFiles())},chooseFiles(){const e=u.get_extname(this.fileExtname);h.St.chooseAndUploadFile({type:this.fileMediatype,compressed:!1,sizeType:this.sizeType,extension:e.length>0?e:void 0,count:this.limitLength-this.files.length,onChooseFile:this.chooseFileCallback,onUploadProgress:e=>{this.setProgress(e,e.index)}}).then((e=>{this.setSuccessAndError(e.tempFiles)})).catch((e=>{console.log("选择失败",e)}))},async chooseFileCallback(e){const s=u.get_extname(this.fileExtname);(1===Number(this.limitLength)&&this.disablePreview&&!this.disabled||"object"===this.returnType)&&(this.files=[]);let{filePaths:l,files:a}=u.get_files_and_is_max(e,s);s&&s.length>0||(l=e.tempFilePaths,a=e.tempFiles);let r=[];for(let p=0;p<a.length&&!(this.limitLength-this.files.length<=0);p++){a[p].uuid=Date.now();let e=await u.get_file_data(a[p],this.fileMediatype);e.progress=0,e.status="ready",this.files.push(e),r.push((h=o({},e),n={file:a[p]},t(h,i(n))))}var h,n;this.$emit("select",{tempFiles:r,tempFilePaths:l}),e.tempFiles=a,this.autoUpload&&!this.noSpace||(e.tempFiles=[])},uploadFiles(e){e=[].concat(e),n.uploadCloudFiles.call(this,e,5,(e=>{this.setProgress(e,e.index,!0)})).then((e=>{this.setSuccessAndError(e)})).catch((e=>{console.log(e)}))},async setSuccessAndError(e,t){let i=[],s=[],l=[],a=[];for(let r=0;r<e.length;r++){const t=e[r],o=t.uuid?this.files.findIndex((e=>e.uuid===t.uuid)):t.index;if(-1===o||!this.files)break;if("request:fail"===t.errMsg)this.files[o].url=t.path,this.files[o].status="error",this.files[o].errMsg=t.errMsg,s.push(this.files[o]),a.push(this.files[o].url);else{this.files[o].errMsg="",this.files[o].fileID=t.url;/cloud:\/\/([\w.]+\/?)\S*/.test(t.url)?this.files[o].url=await this.getTempFileURL(t.url):this.files[o].url=t.url,this.files[o].status="success",this.files[o].progress+=1,i.push(this.files[o]),l.push(this.files[o].fileID)}}i.length>0&&(this.setEmit(),this.$emit("success",{tempFiles:this.backObject(i),tempFilePaths:l})),s.length>0&&this.$emit("fail",{tempFiles:this.backObject(s),tempFilePaths:a})},setProgress(e,t,i){this.files.length;const s=Math.round(100*e.loaded/e.total);let l=t;i||(l=this.files.findIndex((t=>t.uuid===e.tempFile.uuid))),-1!==l&&this.files[l]&&(this.files[l].progress=s-1,this.$emit("progress",{index:l,progress:parseInt(s),tempFile:this.files[l]}))},delFile(e){this.$emit("delete",{tempFile:this.files[e],tempFilePath:this.files[e].url}),this.files.splice(e,1),this.$nextTick((()=>{this.setEmit()}))},getFileExt(e){const t=e.lastIndexOf("."),i=e.length;return{name:e.substring(0,t),ext:e.substring(t+1,i)}},setEmit(){let e=[];"object"===this.returnType?(e=this.backObject(this.files)[0],this.localValue=e||null):(e=this.backObject(this.files),this.localValue||(this.localValue=[]),this.localValue=[...e]),this.$emit("update:modelValue",this.localValue)},backObject(e){let t=[];return e.forEach((e=>{t.push({extname:e.extname,fileType:e.fileType,image:e.image,name:e.name,path:e.path,size:e.size,fileID:e.fileID,url:e.url})})),t},async getTempFileURL(e){e={fileList:[].concat(e)};return(await h.St.getTempFileURL(e)).fileList[0].tempFileURL||""},getForm(e="uniForms"){let t=this.$parent,i=t.$options.name;for(;i!==e;){if(t=t.$parent,!t)return!1;i=t.$options.name}return t}}};if(!Array){(h.resolveComponent("upload-image")+h.resolveComponent("upload-file"))()}var d=h._export_sfc(p,[["render",function(e,t,i,s,l,a){return h.e({a:i.title},i.title?{b:h.t(i.title),c:h.t(a.filesList.length),d:h.t(a.limitLength)}:{},{e:"image"===i.fileMediatype&&"grid"===a.showType},"image"===i.fileMediatype&&"grid"===a.showType?{f:h.o(a.uploadFiles),g:h.o(a.choose),h:h.o(a.delFile),i:h.p({readonly:i.readonly,"image-styles":i.imageStyles,"files-list":a.filesList,limit:a.limitLength,disablePreview:i.disablePreview,delIcon:i.delIcon})}:{},{j:"image"!==i.fileMediatype||"grid"!==a.showType},"image"!==i.fileMediatype||"grid"!==a.showType?{k:h.o(a.uploadFiles),l:h.o(a.choose),m:h.o(a.delFile),n:h.p({readonly:i.readonly,"list-styles":i.listStyles,"files-list":a.filesList,showType:a.showType,delIcon:i.delIcon})}:{})}]]);wx.createComponent(d);
